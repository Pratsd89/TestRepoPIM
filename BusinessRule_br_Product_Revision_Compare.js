/*===== export metadata =====
{
  "contextId" : "EN_CA",
  "workspaceId" : "Main"
}
*/
/*===== business rule definition =====
{
  "id" : "br_Product_Revision_Compare",
  "type" : "BusinessAction",
  "setupGroups" : [ "Actions" ],
  "name" : "Product Revision compare",
  "description" : null,
  "scope" : "Global",
  "validObjectTypes" : [ ],
  "allObjectTypesValid" : true,
  "runPrivileged" : false,
  "onApprove" : "Never",
  "dependencies" : [ ]
}
*/
/*===== business rule plugin definition =====
{
  "pluginId" : "JavaScriptBusinessActionWithBinds",
  "binds" : [ {
    "contract" : "CurrentObjectBindContract",
    "alias" : "node",
    "parameterClass" : "null",
    "value" : null,
    "description" : null
  }, {
    "contract" : "ManagerBindContract",
    "alias" : "step",
    "parameterClass" : "null",
    "value" : null,
    "description" : null
  }, {
    "contract" : "QueryHomeBindContract",
    "alias" : "queryHome",
    "parameterClass" : "null",
    "value" : null,
    "description" : null
  }, {
    "contract" : "ObjectTypeBindContract",
    "alias" : "ccObjectType",
    "parameterClass" : "com.stibo.core.domain.impl.ObjectTypeImpl",
    "value" : "CustomerChoice",
    "description" : null
  }, {
    "contract" : "ObjectTypeBindContract",
    "alias" : "styleObjectType",
    "parameterClass" : "com.stibo.core.domain.impl.ObjectTypeImpl",
    "value" : "Style",
    "description" : null
  }, {
    "contract" : "MailHomeBindContract",
    "alias" : "mail",
    "parameterClass" : "null",
    "value" : null,
    "description" : null
  }, {
    "contract" : "AttributeBindContract",
    "alias" : "ccAttr",
    "parameterClass" : "com.stibo.core.domain.impl.AttributeImpl",
    "value" : "a_CC_Life_Cycle_Status",
    "description" : null
  } ],
  "messages" : [ ],
  "pluginType" : "Operation"
}
*/
exports.operation0 = function (node,step,queryHome,ccObjectType,styleObjectType,mail,ccAttr) {
log.info("starttt")
var filePath = "/opt/stibo/Product_Name_Report.csv";
var file = new java.io.File(filePath);
if (!file.exists()) {
    file.createNewFile();
}
var fw = new java.io.FileWriter(file, false);
fw.write("ID,Name,Latest RevisionDate,First May Revision Name,May Revision Date\n");

function getNodeList() {
	var nodeList = new java.util.ArrayList();
	java.util.Collections.addAll(nodeList,"000817271000,000817264000,000828365004,000847976000,000847993000,000847994000,000847957003,000847957001,000847957002,000847960000,000847974000,000816879006,000844801000,000849997000,000816977000,000844746000,000816919000,000816988000,000844729000,000844787001,000844787000,000844787003,000844822000,000844795001,000844808000,000844794000,000844760001,000844760000,000844769001,000816850001,000820256001,000820256000,000844737000,000844771001,001171564001,000844767000,000844767001,000844786001,000844786000,000844776000,000844741002,000844741000,000844741003,000844780000,000844779001,000844779000,000844784000,000844772005,000844772003,000848091000,000848078000,000800610002,000800610003,000821514000,000821514001,000848096000,000848103000,000848101000,000819983004,000819983003,000819822006,000819826007,000819826010,000819826008,000819826009,000819826011,000819826012,000819854005,000819854006,000819855003,000819855004,000799155000,000799154001,000799154000,000844092000,000844090000,000847932000,000847926000,000847926001,000847930000,000844094000,000453317015,000500474023,000500474025,000500474027,000500474024,000799157000,000799157001,000799157002,000799157003,000819857003,000819857004,000847928000,000820827001,000820960002,000855873000,000855873001,000820815007,000853880000,000853880001,000855893000,000856051001,000856051002,000856225000,000856225001,000856332000,000821081002,000821081001,000821077001,000850289001,000850289000,000790324003,000820885001,000821014003,000855867001,000844985000,000844985001,000850305001,000850305000,000856237000,000821138000,000821087000,000821083000,000856293000,000820967007,000820967008,000820967010,000850431000,000850431001,000855865000,000820813002,000844982000,000790211001,000790211000,000856161000,000856064000,000856146000,000790470001,000790470002,000790470000,000790476001,000790476000,000790474000,000790474001,000845183000,000814182001,000818589002,000818589005,000818589006,000818589001,000818589007,000818589004,000818589000,000818589003,000818589009,000818589008,000818610003,000848536002,000547250085,000818643001,000683050015,000683050016,000683050020,000818954000,000818954002,000818954001,000845179000,000819070007,000797098069,000797098068,000734428013,000734428012,000734455002,000734455003,000734455004,000734455005,000818650001,000853339000,001171570000,001171569000,000780886003,000780886002,000780886004,001171571000,000819313000,000844839000,000844846000,000844841000,000790444001,000790444000,000845388000,000845388002,000845388001,000845384001,000845384000,000790431005,000790431004,000790431000,000790468001,000790468002,000790468000,000790430002,000790430003,000790430004,000790466002,000790466004,000790466001,000790466003,000790466000,000790443006,000790443005,000790443000,000845417000,000845417002,000818969005,000819111004,000819111003,000819111007,000845188000,000820764003,000820762009,000820762010,000826470002,000845016001,000845016004,000845021000,000845051000,000844998002,000844998003,000801621000,000845262000,000845258000,000845253001,000815455003,000855135000,000855705000,000815522003,000815522002,000853893002,000853893000,000814908000,000815160000,000815397003,000815405000,000815405004,000815405005,000815405006,000855104000,000855104003,000855107000,000736070013,000853896003,000853896002,000822360000,000857000001,000857000000,000734331019,000734331020,000844463002,000856526000,000627454034,000844375002,000844375003,000844375000,000845458000,000845537000,000845537001,000845541000,000817294004,000817294005,000817294006,000817294008,000817294007,000817298003,000817298004,000817355003,000817309000,000817309002,000817309004,000817415004,000817415002,000849388000,000849366000,000856557003,000856557001,000856557002,000856557000,000856529003,000856529001,000820057000,000844060000,000844067000,000845451000,000845459000,000845545000,000845543000,000856644000,000845005001,000845005002,000799622000,000799622001,000816623000,000844032001,000844032000,000849355000,000854634000,000817619003,000817617005,000817617008,000817617009,000821403001,000821501004,000847387000,000847387002,000847387003,001171563002,001171563003,001171563000,000848110000,000848109000,000817108000,000828374000,000828374001,000828374004,000828374003,000844034000,000847553002,000847553004,000847553003,000847553001,000847553000,000847363002,000847363004,000847363006,000847363007,001171568000,000847328000,000847328003,001171519001,001171519002,000844486001,000844486000,000847342000,000847346000,000847403000,001171518002,001171518000,000713469002,000815592000,000833435000,000833445000,000833432000,000833428000,000833447000,000844699000,000844697000,000815605002,000844701000,000835152001,000835152000,000851059000,000853555000,000821945000,000822028000,000822028001,000835150002,000835150003,000835150001,000835150000,000835150004,000781177001,000821319000,000835159000,000845742000,000845736000,000845741000,000845744000,000856821000,001171561000,000804438001,000804438002,000804438000,000781687006,000800592001,000800592000,000800605002,000800593004,000800593005,000800593006,000800593003,000821871013,000821871016,000835060001,000835060002,000835060003,000821939000,000821939001,000821977006,000835054001,000845754000,000715000009,000817121008,000826204000,000848115000,000746387011,000746387013,000746387012,000833672000,000833672008,000835136000,000835136002,000835128005,000835128004,000856695000,000856695002,000856695001,000835122007,000835122002,000835130000,000835135004,000835135006,000835135007,000835140002,000835134000,000852564000,000856694000,000856694001,000856694002,000835133000,000845758000,000827174000,000845729000,000845729001,000845732000,000821329002,000845727000,000845730000,000846824005,000846824000,000846824004,000846824003,000846808001,000846808002,000854617002,000854617003,000854617001,000854617000,000800465001,000800465004,000800465005,000800465003,000800465002,000800465000,000800465008,000800465006,000800465007,000846799003,000846799001,000846799000,000846799002,000846799004,000617919003,000846805004,000846805005,000846805002,000846805001,000846805007,000856866016,000856866004,000856866009,000856884002,000856884001,000856884000,000856872002,000856872000,000856872001,000856872004,000856872003,000852878004,000852878002,000852878001,000837251005,000856904000,000856904001,000852874000,000852874003,000852874007,000852874002,000852874004,000852874005,000856887001,000856887000,000856887003,000856887002,000852872001,000852872006,000852872000,000852872002,000852872003,000852872008,000856906000,000856906002,000856937000,000836106001,000814554001,000845158000,000845154001,000845154007,000845154002,000608869010,000816697008,000816697013,000844229000,000844229003,000844371002,000844371000,000844371001,000853412000,000844367000,000844367003,000844367001");
return nodeList;
}
ccList = getNodeList();
for (var i = 0; i < ccList.size(); i++) {
	var cc = step.getProductHome().getProductByID(ccList.get(i));
	revisions = cc.getRevisions();
	name = "\""+revisions.get(0).getNode().getName() + "\""+","+revisions.get(0).getCreatedDate()+",";
	for(var i=1;i<revisions.size();i++) {
		 thisrevision = revisions.get(i);
		 if(thisrevision.getCreatedDate().toString().contains("May")) {
		 	//log.info(thisrevision.getCreatedDate().toString());
		 	name += "\""+thisrevision.getNode().getName() + "\""+","+thisrevision.getCreatedDate()+",";
		 	break;
		 }		
	}
	fw.write(cc.getID() + "," + name  + "\n")
}
fw.flush();
fw.close();

// Upload file to asset
var fileInputStream = new java.io.FileInputStream(file);
var asset = step.getAssetHome().getAssetByID("Product_Name_Report");
var uploaded = asset.upload(fileInputStream, filePath);
var mailMethod = mail.mail();
mailMethod.addTo("sai_preethi_mandipalli@gap.com");
//mailMethod.addTo("sai_preethi_mandipalli@gap.com;jagadish_beejapu@gap.com;Sri_Indu_Dekkapati@gap.com");
//mailMethod.addTo("sai_preethi_mandipalli@gap.com;jagadish_beejapu@gap.com;Uttamareddy_Manda@gap.com");
mailMethod.subject("Product Name Revision Report - "+node.getName());
mailMethod.plainMessage("");

// Attach CSV
var attachment = mailMethod.attachment();
attachment.fromAsset(asset);
attachment.name("ProductNameReport.csv");
attachment.attach();

// Send
var mailSentStatus = mailMethod.send();

log.info("enddd")
}